Metadata-Version: 2.1
Name: actiDep
Version: 0.1.0
Summary: Package de traitement de la base de donnÃ©es ActiDep
Home-page: https://github.com/nathandecaux/ActiDep
Author: Nathan Decaux
Author-email: nathan.decaux@irisa.fr
Classifier: Programming Language :: Python :: 3
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Requires-Python: >=3.6
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: pandas
Requires-Dist: numpy
Requires-Dist: matplotlib

# actiDep - Pipeline de Traitement des DonnÃ©es de Diffusion

[![Python Version](https://img.shields.io/badge/python-3.8%2B-blue.svg)](https://python.org)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

`actiDep` est un package Python complet pour le traitement et l'analyse des donnÃ©es de diffusion IRM dans le cadre du projet ActiDep. Il fournit une pipeline modulaire et extensible pour l'analyse microstructurelle, la tractographie et la tractomÃ©trie.

## ğŸ“‹ Table des MatiÃ¨res

- [Installation](#-installation)
- [Configuration](#ï¸-configuration)
- [Structure du Projet](#-structure-du-projet)
- [Utilisation](#-utilisation)
- [Modules Principaux](#-modules-principaux)
- [API Reference](#-api-reference)
- [Exemples](#-exemples)
- [Contribuer](#-contribuer)
- [License](#-license)

## ğŸš€ Installation

### PrÃ©requis

- Python 3.8+
- FSL (FMRIB Software Library)
- ANIMA (Medical Imaging Analysis software)
- MRtrix3
- TractSeg
- ANTs (Advanced Normalization Tools)

### Installation du package

```bash
# Clone du repository
git clone https://github.com/nathandecaux/ActiDep.git
cd ActiDep

# Installation des dÃ©pendances
pip install -r requirements.txt

# Installation en mode dÃ©veloppement
pip install -e .
```

## âš™ï¸ Configuration

### Configuration ANIMA

CrÃ©ez le fichier `~/.anima/config.txt` :

```ini
[anima-scripts]
anima = /path/to/anima/bin
extra-data-root = /path/to/anima/data
anima-scripts-public-root = /path/to/anima/scripts/public
anima-scripts-root = /path/to/anima/scripts
```

### Configuration TractSeg

CrÃ©ez le fichier `~/.tractseg-config/config.txt` :

```ini
[tractseg]
tractseg-bin = /path/to/tractseg/bin
mrtrix-bin = /path/to/mrtrix/bin
```

## ğŸ“ Structure du Projet

```text
actiDep/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ core.py                    # Module principal
â”œâ”€â”€ set_config.py             # Configuration des outils externes
â”œâ”€â”€ analysis/                 # Modules d'analyse
â”‚   â”œâ”€â”€ fiber_density.py     # Analyse de densitÃ© de fibres
â”‚   â”œâ”€â”€ mcm_odf.py           # Analyse MCM et ODF
â”‚   â”œâ”€â”€ microstructure.py    # Analyse microstructurelle
â”‚   â”œâ”€â”€ stats.ipynb          # Analyses statistiques
â”‚   â””â”€â”€ tractometry.py       # TractomÃ©trie
â”œâ”€â”€ atlasing/                # Modules d'atlasing
â”‚   â”œâ”€â”€ actidep_atlasing.py  # Atlasing spÃ©cifique ActiDep
â”‚   â”œâ”€â”€ HCP_atlasing.py      # Atlasing HCP
â”‚   â”œâ”€â”€ HCP_atlasing_anima.py
â”‚   â””â”€â”€ HCP_averaging.py     # Moyennage de tractogrammes
â”œâ”€â”€ data/                    # Gestion des donnÃ©es
â”‚   â”œâ”€â”€ ancp_loader.py       # Chargeur ANCP
â”‚   â”œâ”€â”€ io.py                # EntrÃ©es/sorties
â”‚   â”œâ”€â”€ loader.py            # Chargeur principal BIDS
â”‚   â””â”€â”€ mcmfile.py           # Gestion fichiers MCM
â”œâ”€â”€ pipeline/                # Pipelines de traitement
â”‚   â”œâ”€â”€ bundle_seg.py        # Segmentation de faisceaux
â”‚   â”œâ”€â”€ classifyber.py       # Classification de fibres
â”‚   â”œâ”€â”€ mcm_3_comparts.py    # ModÃ¨le MCM 3 compartiments
â”‚   â”œâ”€â”€ msmt_csd.py          # Multi-Shell Multi-Tissue CSD
â”‚   â”œâ”€â”€ preprocessing.py     # PrÃ©traitement
â”‚   â”œâ”€â”€ recobundle_segmentation.py
â”‚   â””â”€â”€ tractseg_pipeline.py # Pipeline TractSeg
â”œâ”€â”€ ui/                      # Interface utilisateur
â”‚   â”œâ”€â”€ browser.py           # Navigateur de donnÃ©es
â”‚   â”œâ”€â”€ tractometry_dashboard.py # Dashboard tractomÃ©trie
â”‚   â””â”€â”€ templates/           # Templates web
â”œâ”€â”€ utils/                   # Utilitaires
â”‚   â”œâ”€â”€ clustering.py        # Clustering de streamlines
â”‚   â”œâ”€â”€ converters.py        # Convertisseurs de format
â”‚   â”œâ”€â”€ fod.py               # Fonctions FOD
â”‚   â”œâ”€â”€ hash_utils.py        # Utilitaires de hash
â”‚   â”œâ”€â”€ mcm.py               # Utilitaires MCM
â”‚   â”œâ”€â”€ recobundle.py        # Segmentation RecoBundles
â”‚   â”œâ”€â”€ registration.py     # Recalage d'images
â”‚   â”œâ”€â”€ segmentation.py     # Segmentation
â”‚   â”œâ”€â”€ tools.py            # Outils gÃ©nÃ©riques
â”‚   â”œâ”€â”€ tractography.py     # Tractographie
â”‚   â””â”€â”€ tractseg_utils.py   # Utilitaires TractSeg
â””â”€â”€ visualisation/          # Visualisation
    â”œâ”€â”€ atlas_visu.py       # Visualisation d'atlas
    â”œâ”€â”€ centroids_params.py # Interface clustering
    â””â”€â”€ create_rotating_3D_gif.py
```

## ğŸ”§ Utilisation

### Exemple de base

```python
from actiDep.data.loader import Actidep, Subject
from actiDep.analysis.tractometry import process_projection
from actiDep.set_config import set_config

# Configuration
config, tools = set_config()

# Chargement des donnÃ©es
dataset = Actidep("/path/to/bids/dataset")
subject = Subject("01002", db_root="/path/to/bids/dataset")

# RÃ©cupÃ©ration des fichiers
fa_files = subject.get(pipeline='anima_preproc', metric='FA', extension='nii.gz')
tracto_files = subject.get(pipeline='bundle_seg', suffix='tracto', extension='trk')

# Analyse tractomÃ©trique
results = process_projection(tracto_files, fa_files)
```

### Pipeline complet

```python
from actiDep.pipeline.msmt_csd import process_response, process_fod
from actiDep.pipeline.bundle_seg import run_bundle_segmentation
from actiDep.analysis.tractometry import process_tractseg_analysis

# 1. Calcul des rÃ©ponses tissulaires
process_response(subject, dwi_data, "msmt_csd")

# 2. Calcul des FOD
process_fod(subject, dwi_data, "msmt_csd")

# 3. Segmentation de faisceaux
run_bundle_segmentation(subject, "bundle_seg")

# 4. Analyse tractomÃ©trique
process_tractseg_analysis("subjects.txt", metric='FA')
```

## ğŸ“š Modules Principaux

### ğŸ”¬ Analysis

#### `tractometry.py`

Module principal pour l'analyse tractomÃ©trique des faisceaux de substance blanche.

**Fonctions principales :**

- `evaluate_along_streamlines()` : Ã‰valuation de mÃ©triques le long des streamlines
- `process_projection()` : Projection de mÃ©triques sur les faisceaux
- `process_tractseg_analysis()` : Analyse complÃ¨te avec TractSeg

**Algorithmes disponibles :**

- `equal_dist` : Ã‰chantillonnage Ã©quidistant
- `distance_map` : AgrÃ©gation par cartes de distance (cKDTree)
- `cutting_plane` : Approche par plans de coupe
- `afq` : MÃ©thode AFQ (Automated Fiber Quantification)

#### `fiber_density.py`

Analyse de la densitÃ© de fibres et crÃ©ation de templates avec ANTs.

#### `microstructure.py`

Analyse microstructurelle avec traitement des fichiers VTK/MCM.

### ğŸ—‚ï¸ Data

#### `loader.py`

SystÃ¨me de chargement compatible BIDS avec la classe `ActiDepFile` comme alternative lÃ©gÃ¨re Ã  PyBIDS.

**Classes principales :**

- `ActiDepFile` : ReprÃ©sentation d'un fichier BIDS
- `Subject` : Gestion d'un sujet individuel
- `Actidep` : Interface pour l'ensemble du dataset

#### `io.py`

Fonctions d'entrÃ©es/sorties avec conversion automatique entre formats.

### ğŸ”„ Pipeline

#### `msmt_csd.py`

Pipeline Multi-Shell Multi-Tissue Constrained Spherical Deconvolution.

**Ã‰tapes :**

1. Calcul des rÃ©ponses tissulaires (`process_response`)
2. Estimation des FOD (`process_fod`)
3. Normalisation (`process_normalize`)
4. Analyse basÃ©e sur les fixels (`process_fixels`)
5. Tractographie iFOD2 (`process_ifod2_tracto`)

#### `bundle_seg.py`

Segmentation automatique de faisceaux avec RecoBundles et TractSeg.

### ğŸ› ï¸ Utils

#### `tractography.py`

GÃ©nÃ©ration et manipulation de tractogrammes.

**Fonctions :**

- `generate_ifod2_tracto()` : Tractographie iFOD2 avec MRtrix
- `generate_trekker_tracto()` : Tractographie avec Trekker
- `get_tractogram_endings()` : DÃ©tection des extrÃ©mitÃ©s de faisceaux

#### `registration.py`

Recalage d'images avec ANTs et autres outils.

#### `mcm.py`

Utilitaires pour les modÃ¨les Multi-Compartment Model (MCM).

### ğŸ¨ Visualisation

#### `centroids_params.py`

Interface interactive pour le clustering de tractogrammes avec QuickBundles.

#### `atlas_visu.py`

Visualisation d'atlas et de tractogrammes.

## ğŸ“Š API Reference

### Configuration

```python
from actiDep.set_config import set_config, get_HCP_bundle_names

# Configuration des outils
config, tools = set_config()

# Noms des faisceaux HCP
bundle_names = get_HCP_bundle_names()
```

### Chargement des DonnÃ©es

```python
from actiDep.data.loader import Actidep, Subject

# Dataset complet
dataset = Actidep("/path/to/dataset")
subjects = dataset.get_subjects()

# Sujet individuel
subject = Subject("01002")
files = subject.get(pipeline="anima_preproc", suffix="mask", label="brain")
```

### Analyse TractomÃ©trique

```python
from actiDep.analysis.tractometry import evaluate_along_streamlines

# Ã‰valuation le long des streamlines
means, stds = evaluate_along_streamlines(
    scalar_img=fa_data,
    streamlines=tractogram,
    nr_points=100,
    affine=affine
)
```

### Pipeline de Traitement

```python
from actiDep.pipeline.msmt_csd import process_response, process_fod

# RÃ©ponses tissulaires
responses = process_response(subject, dwi_file, "pipeline_name")

# Fonctions d'orientation de fibres
fods = process_fod(subject, dwi_file, "pipeline_name")
```

## ğŸ’¡ Exemples

### Analyse TractomÃ©trique ComplÃ¨te

```python
#!/usr/bin/env python3
"""
Exemple d'analyse tractomÃ©trique complÃ¨te
"""

from actiDep.data.loader import Actidep
from actiDep.analysis.tractometry import process_tractseg_analysis

# Configuration du dataset
dataset_path = "/path/to/actidep/bids"
subjects_file = "subjects.txt"

# Analyse tractomÃ©trique avec TractSeg
process_tractseg_analysis(
    subjects_txt=subjects_file,
    dataset_path=dataset_path,
    metric='FA',  # ou 'MD', 'RD', 'AD'
    with_3dplot=True
)
```

### Pipeline de Segmentation de Faisceaux

```python
#!/usr/bin/env python3
"""
Pipeline de segmentation automatique de faisceaux
"""

from actiDep.data.loader import Subject
from actiDep.pipeline.bundle_seg import run_bundle_segmentation
from actiDep.utils.recobundle import create_whole_brain_tract

# Sujet d'exemple
subject = Subject("01002")

# Segmentation des faisceaux
results = run_bundle_segmentation(subject, "bundle_seg")

# CrÃ©ation d'un tractogramme complet
whole_brain = create_whole_brain_tract(
    tract_list=results['tracts'],
    ref_image=results['reference']
)
```

### Clustering Interactif

```python
#!/usr/bin/env python3
"""
Interface interactive pour le clustering de tractogrammes
"""

from actiDep.visualisation.centroids_params import TractoClusteringApp

# Lancement de l'interface
app = TractoClusteringApp()
app.load_data(
    tractogram_file="/path/to/tractogram.trk",
    anatomy_file="/path/to/anatomy.nii.gz"
)
app.run()
```

### Analyse Microstructurelle

```python
#!/usr/bin/env python3
"""
Analyse des paramÃ¨tres microstructurels avec MCM
"""

from actiDep.analysis.microstructure import MCMVTKReader
from actiDep.utils.mcm import project_to_central_line_from_vtk

# Lecture des donnÃ©es MCM
vtk_file = "/path/to/mcm_tractogram.vtk"
reader = MCMVTKReader(vtk_file)

# Extraction des paramÃ¨tres
metadata = reader.get_metadata()
streamlines = reader.extract_streamlines(0, 10)

# Projection sur ligne centrale
project_to_central_line_from_vtk(
    vtk_file_path=vtk_file,
    reference_nifti_path="/path/to/reference.nii.gz",
    output_path="/path/to/output.vtk"
)
```

## ğŸ§ª Tests

Le projet inclut une suite de tests dans le dossier `tests/` :

```bash
# ExÃ©cution des tests
python -m pytest tests/

# Tests spÃ©cifiques
python tests/test_core.py
python tests/test_transfo.py
```

## ğŸ“ˆ Formats de DonnÃ©es SupportÃ©s

### Formats d'EntrÃ©e

- **Images :** NIfTI (.nii, .nii.gz), NRRD, Analyze
- **Tractogrammes :** TRK, TCK, VTK, PLY
- **Gradients :** FSL (.bval/.bvec), MRtrix (.b)
- **Transformations :** ITK (.mat, .txt), ANTs (.h5)

### Formats de Sortie

- **MÃ©triques :** CSV, JSON, NIfTI
- **Tractogrammes :** TRK, TCK, VTK
- **Visualisations :** PNG, HTML (plotly), GIF

## ğŸ”§ Configuration AvancÃ©e

### Variables d'Environnement

```bash
export ANIMA_SCRIPTS_DIR="/path/to/anima/scripts"
export TRACTSEG_DIR="/path/to/tractseg"
export MRTRIX_DIR="/path/to/mrtrix"
export ACTIDEP_DATA="/path/to/actidep/data"
```

### ParallÃ©lisation

```python
from actiDep.utils.tools import run_cli_command

# Utilisation de plusieurs cÅ“urs
results = run_cli_command(
    command="anima_command",
    inputs=inputs,
    output_patterns=patterns,
    n_cores=8
)
```

## ğŸ¤ Contribuer

1. Fork le projet
2. CrÃ©ez une branche feature (`git checkout -b feature/AmazingFeature`)
3. Committez vos changements (`git commit -m 'Add some AmazingFeature'`)
4. Push vers la branche (`git push origin feature/AmazingFeature`)
5. Ouvrez une Pull Request

### Standards de Code

- Suivre PEP 8
- Documenter les fonctions avec des docstrings
- Inclure des tests pour les nouvelles fonctionnalitÃ©s
- Utiliser type hints quand appropriÃ©

## ğŸ“ License

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de dÃ©tails.

## ğŸ‘¨â€ğŸ’» Auteur

**Nathan Decaux** - *DÃ©veloppeur principal* - [nathan.decaux@irisa.fr](mailto:nathan.decaux@irisa.fr)

## ğŸ™ Remerciements

- Ã‰quipe EMPENN (IRISA/INRIA)
- Projet ActiDep
- CommunautÃ©s FSL, MRtrix, ANIMA et TractSeg

## ğŸ“š RÃ©fÃ©rences

- Wassermann, D. et al. (2016). The white matter query language. Nature Methods.
- Yeatman, J. D. et al. (2012). Tract profiles of white matter properties. PLoS One.
- Wasserthal, J. et al. (2018). TractSeg - Fast and accurate white matter tract segmentation.

---

Pour plus d'informations, consultez la [documentation complÃ¨te](https://github.com/nathandecaux/ActiDep/wiki) ou crÃ©ez une [issue](https://github.com/nathandecaux/ActiDep/issues) pour poser vos questions.
